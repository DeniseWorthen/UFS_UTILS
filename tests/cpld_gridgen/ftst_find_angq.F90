! Unit test for cpld_gridgen routine "find_angq".
!
! Reads a sample MOM6 supergrid and calculates the
! rotation angle on corner points
!
! Author Denise Worthen 2/08/2022

  program ftst_find_angq
 
  use grdvars,       only : nx,ny,x,y,xsgp1,ysgp1,angq
  use angles,        only : find_angq

  implicit none

  integer :: i,j,i1, i2

  logical :: mastertask = .false.
  logical :: debug = .false.

  ! reduced (output) grid dimensions
  integer, parameter :: lni = 12, lnj = 7
  ! supergrid dimensions
  integer, parameter :: lnx = 2*lni, lny = 2*lnj

  ! pole locations on SG
  integer :: ipolesg(2)
  real(kind=8) :: delta(15)
  real(kind=8) :: sumdelta, angdelta, angtdelta
  real(kind=8) :: sg_maxlat
  ! expected corner angle values on supergrid along j=lny
  real(kind=8), dimension(0:lnx) :: angle_expected

  ! test supergrid values
  real(kind=4) :: sgx(0:lnx,0:lny)
  real(kind=4) :: sgy(0:lnx,0:lny)

  ! supergrid x,y and angles on corners
  allocate (x(0:lnx,0:lny), y(0:lnx,0:lny), angq(0:lnx,0:lny))
  ! supergrid "plus 1" arrays
  allocate (xsgp1(0:lnx,0:lny+1), ysgp1(0:lnx,0:lny+1))

 data sgy &
         /-85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,&
          -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,&
          -85.00,  -85.00,  -85.00,  -85.00,  -85.00,&
          -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,&
          -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,&
          -72.50,  -72.50,  -72.50,  -72.50,  -72.50,&
          -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,&
          -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,&
          -60.00,  -60.00,  -60.00,  -60.00,  -60.00,&
          -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,&
          -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,&
          -47.50,  -47.50,  -47.50,  -47.50,  -47.50,&
          -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,&
          -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,&
          -35.00,  -35.00,  -35.00,  -35.00,  -35.00,&
          -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,&
          -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,&
          -22.50,  -22.50,  -22.50,  -22.50,  -22.50,&
          -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,&
          -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,&
          -10.00,  -10.00,  -10.00,  -10.00,  -10.00,&
            2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,&
            2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,&
            2.50,    2.50,    2.50,    2.50,    2.50,&
           15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,&
           15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,&
           15.00,   15.00,   15.00,   15.00,   15.00,&
           27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,&
           27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,&
           27.50,   27.50,   27.50,   27.50,   27.50,&
           40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,&
           40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,&
           40.00,   40.00,   40.00,   40.00,   40.00,&
           52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,&
           52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,&
           52.50,   52.50,   52.50,   52.50,   52.50,&
           65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,&
           65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,&
           65.00,   65.00,   65.00,   65.00,   65.00,&
           65.00,   68.57,   71.60,   74.06,   75.92,   77.09,   77.50,   77.09,   75.92,   74.06,&
           71.60,   68.57,   65.00,   68.57,   71.60,   74.06,   75.92,   77.09,   77.50,   77.09,&
           75.92,   74.06,   71.60,   68.57,   65.00,&
           65.00,   70.69,   75.41,   79.51,   83.20,   86.66,   90.00,   86.66,   83.20,   79.51,&
           75.41,   70.69,   65.00,   70.69,   75.41,   79.51,   83.20,   86.66,   90.00,   86.66,&
           83.20,   79.51,   75.41,   70.69,   65.00/

data sgx &
        /-280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -267.99, -255.37, -241.54, -226.02, -208.64, -190.00, -171.36, -153.98, -138.46,&
         -124.63, -112.01, -100.00,  -87.99,  -75.37,  -61.54,  -46.02,  -28.64,  -10.00,    8.64,&
           26.02,   41.54,   55.37,   67.99,   80.00,&
         -280.00, -280.00, -280.00, -280.00, -280.00, -280.00, -100.00, -100.00, -100.00, -100.00,&
         -100.00, -100.00, -100.00, -100.00, -100.00, -100.00, -100.00, -100.00, -100.00,   80.00,&
           80.00,   80.00,   80.00,   80.00,   80.00/

  data angle_expected / 0.00000000, -3.02402352, -0.94998978, -0.92425100, -0.85051272, -0.74357528,&
                        0.13678155,  0.86943193,  0.99637788,  1.09512092,  1.17715679,  1.28528118,&
                        0.77832632, -0.84046526, -0.94998958, -0.92425088, -0.85051270, -0.74357529,&
                       -0.87256414, -0.13592542,  0.99637789,  1.09512090,  1.17715677,  1.28528121,&
                        0.00000000/

  print *,angle_expected
  print *,"Starting test of cpld_gridgen routine find_angq"

  x = sgx
  y = sgy
  nx = lnx
  ny = lny
  sg_maxlat = maxval(y)

  !pole on supergrid
  ipolesg = -1
      j = lny
  do i = 1,lnx/2
   if(y(i,j) .eq. sg_maxlat)ipolesg(1) = i
  enddo
  do i = lnx/2+1,lnx
   if(y(i,j) .eq. sg_maxlat)ipolesg(2) = i
  enddo

  ! test angleq calculation
  call find_angq

  ! required for checking longitudes across seam
  where(xsgp1 .lt. 0.0)xsgp1 = xsgp1 + 360.0

  j = lny
  i1 = ipolesg(1); i2 = ipolesg(2)-(ipolesg(1)-i1)
  delta = 0.0
  ! check lons match across seam
  delta( 1) = xsgp1(i1-2,j)-xsgp1(i2+2,j)
  delta( 2) = xsgp1(i1-1,j)-xsgp1(i2+1,j)
  delta( 3) = xsgp1(i1,  j)-xsgp1(i2,  j)
  delta( 4) = xsgp1(i1+1,j)-xsgp1(i2-1,j)
  delta( 5) = xsgp1(i1+2,j)-xsgp1(i2-2,j)
  ! check lats match across seam
  delta( 6) = ysgp1(i1-2,j)-ysgp1(i2+2,j)
  delta( 7) = ysgp1(i1-1,j)-ysgp1(i2+1,j)
  delta( 8) = ysgp1(i1,  j)-ysgp1(i2,  j)
  delta( 9) = ysgp1(i1+1,j)-ysgp1(i2-1,j)
  delta(10) = ysgp1(i1+2,j)-ysgp1(i2-2,j)
  ! check angq match across seam
  j = lny
  delta(11)=angq(i1-2,j)-angq(i2-2,j)
  delta(12)=angq(i1-1,j)-angq(i2-1,j)
  delta(13)=angq(i1,  j)-angq(i2,  j)
  delta(14)=angq(i1+1,j)-angq(i2+1,j)
  delta(15)=angq(i1+2,j)-angq(i2+2,j)
  do i = 1,15
   print *,i,delta(i)
  end do

  sumdelta = 0.0
  sumdelta = sum(delta)
  print *,sumdelta

  angdelta = 0.0
  j = lny
  do i = 1,lnx
   angdelta = angdelta + (angq(i,j) - angle_expected(i))
   print '(i6,3f12.8)',i, angdelta,angq(i,j),angle_expected(i)
  end do

  if (sumdelta == 0.0 .and. angdelta <= 1.e-6) then
    print *,'OK'
    print *,'SUCCESS!'
    deallocate(x,y,xsgp1,ysgp1,angq)
  else
    print *,'ftst_find_angq failed'
    stop 1
  endif

  end program ftst_find_angq

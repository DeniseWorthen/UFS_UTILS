! Unit test for cpld_gridgen routine "find_angq".
!
! Reads a sample MOM6 supergrid and calculates the
! rotation angle on corner points
!
! Author Denise Worthen 2/08/2022

  program ftst_find_angq

  use angles,        only : find_angq

  implicit none

  integer :: i,j,i1, i2

  logical :: mastertask = .false.
  logical :: debug = .false.

  ! reduced (output) grid dimensions
  integer, parameter :: ni = 12, nj = 7
  ! supergrid dimensions
  integer, parameter :: nx = 2*ni, ny = 2*nj

  ! pole locations on SG
  integer :: ipolesg(2)
  real(kind=8) :: delta(15)
  real(kind=8) :: sumdelta
  real(kind=8) :: sg_maxlat

  ! test supergrid values
  real(kind=4) :: sgx(0:nx,0:ny)
  real(kind=4) :: sgy(0:nx,0:ny)

  ! supergrid x,y and angles on corners
  real(kind=8) :: x(0:nx,0:ny), y(0:nx,0:ny), angq(0:nx,0:ny)
  ! supergrid "plus 1" arrays
  real(kind=8) :: xsgp1(0:nx,0:ny+1), ysgp1(0:nx,0:ny+1)

 data sgy &
         /-85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,&
          -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,  -85.00,&
          -85.00,  -85.00,  -85.00,  -85.00,  -85.00,&
          -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,&
          -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,  -72.50,&
          -72.50,  -72.50,  -72.50,  -72.50,  -72.50,&
          -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,&
          -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,  -60.00,&
          -60.00,  -60.00,  -60.00,  -60.00,  -60.00,&
          -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,&
          -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,  -47.50,&
          -47.50,  -47.50,  -47.50,  -47.50,  -47.50,&
          -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,&
          -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,  -35.00,&
          -35.00,  -35.00,  -35.00,  -35.00,  -35.00,&
          -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,&
          -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,  -22.50,&
          -22.50,  -22.50,  -22.50,  -22.50,  -22.50,&
          -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,&
          -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,  -10.00,&
          -10.00,  -10.00,  -10.00,  -10.00,  -10.00,&
            2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,&
            2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,    2.50,&
            2.50,    2.50,    2.50,    2.50,    2.50,&
           15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,&
           15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,   15.00,&
           15.00,   15.00,   15.00,   15.00,   15.00,&
           27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,&
           27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,   27.50,&
           27.50,   27.50,   27.50,   27.50,   27.50,&
           40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,&
           40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,   40.00,&
           40.00,   40.00,   40.00,   40.00,   40.00,&
           52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,&
           52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,   52.50,&
           52.50,   52.50,   52.50,   52.50,   52.50,&
           65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,&
           65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,   65.00,&
           65.00,   65.00,   65.00,   65.00,   65.00,&
           65.00,   68.57,   71.60,   74.06,   75.92,   77.09,   77.50,   77.09,   75.92,   74.06,&
           71.60,   68.57,   65.00,   68.57,   71.60,   74.06,   75.92,   77.09,   77.50,   77.09,&
           75.92,   74.06,   71.60,   68.57,   65.00,&
           65.00,   70.69,   75.41,   79.51,   83.20,   86.66,   90.00,   86.66,   83.20,   79.51,&
           75.41,   70.69,   65.00,   70.69,   75.41,   79.51,   83.20,   86.66,   90.00,   86.66,&
           83.20,   79.51,   75.41,   70.69,   65.00/

data sgx &
        /-280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -265.00, -250.00, -235.00, -220.00, -205.00, -190.00, -175.00, -160.00, -145.00,&
         -130.00, -115.00, -100.00,  -85.00,  -70.00,  -55.00,  -40.00,  -25.00,  -10.00,    5.00,&
           20.00,   35.00,   50.00,   65.00,   80.00,&
         -280.00, -267.99, -255.37, -241.54, -226.02, -208.64, -190.00, -171.36, -153.98, -138.46,&
         -124.63, -112.01, -100.00,  -87.99,  -75.37,  -61.54,  -46.02,  -28.64,  -10.00,    8.64,&
           26.02,   41.54,   55.37,   67.99,   80.00,&
         -280.00, -280.00, -280.00, -280.00, -280.00, -280.00, -100.00, -100.00, -100.00, -100.00,&
         -100.00, -100.00, -100.00, -100.00, -100.00, -100.00, -100.00, -100.00, -100.00,   80.00,&
           80.00,   80.00,   80.00,   80.00,   80.00/

  print *,"Starting test of cpld_gridgen routine find_angq"

  x = sgx
  y = sgy

  sg_maxlat = maxval(y)

  !pole on supergrid
  ipolesg = -1
      j = ny
  do i = 1,nx/2
   if(y(i,j) .eq. sg_maxlat)ipolesg(1) = i
  enddo
  do i = nx/2+1,nx
   if(y(i,j) .eq. sg_maxlat)ipolesg(2) = i
  enddo

  ! test angleq calculation
  call find_angq

  ! required for checking longitudes across seam
  where(xsgp1 .lt. 0.0)xsgp1 = xsgp1 + 360.0

  j = ny+1
  i1 = ipolesg(1); i2 = ipolesg(2)-(ipolesg(1)-i1)
  delta = 0.0
  ! check lons match across seam
  delta( 1) = xsgp1(i1-2,j)-xsgp1(i2+2,j)
  delta( 2) = xsgp1(i1-1,j)-xsgp1(i2+1,j)
  delta( 3) = xsgp1(i1,  j)-xsgp1(i2,  j)
  delta( 4) = xsgp1(i1+1,j)-xsgp1(i2-1,j)
  delta( 5) = xsgp1(i1+2,j)-xsgp1(i2-2,j)
  ! check lats match across seam
  delta( 6) = ysgp1(i1-2,j)-ysgp1(i2+2,j)
  delta( 7) = ysgp1(i1-1,j)-ysgp1(i2+1,j)
  delta( 8) = ysgp1(i1,  j)-ysgp1(i2,  j)
  delta( 9) = ysgp1(i1+1,j)-ysgp1(i2-1,j)
  delta(10) = ysgp1(i1+2,j)-ysgp1(i2-2,j)
  ! check angq match across seam
  j = ny
  delta(11)=angq(i1-2,j)-angq(i2-2,j)
  delta(12)=angq(i1-1,j)-angq(i2-1,j)
  delta(13)=angq(i1,  j)-angq(i2,  j)
  delta(14)=angq(i1+1,j)-angq(i2+1,j)
  delta(15)=angq(i1+2,j)-angq(i2+2,j)

  sumdelta = 0.0
  sumdelta = sum(delta)

  if (sumdelta == 0.0) then
    print *,'OK'
    print *,'SUCCESS!'
  else
    print *,'ftst_find_angq failed'
    stop 1
  endif

  end program ftst_find_angq
